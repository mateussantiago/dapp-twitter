<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>RIFA</title>
    <link href='https://fonts.googleapis.com/css?family=Open Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='bootstrap.min.css' rel='stylesheet' type='text/css'>
    <script language="javascript" type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/web3-min-js@1.0.0/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="abi.js"></script>
</head>

<body class="bg-light">

    <div class="container">
        <div class="py-5 text-center">
            <h2>Rifas IMD</h2>
            <p class="lead">Exemplo de front-end para um smart contract da rede Ethereum.</p>
        </div>

        <div class="row">
            <div class="col-md order-md mb">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Rifa IMD</span>
                    <span class="badge badge-secondary badge-pill" id="preco">Preço da Rifa: -</span>
                </h4>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                        <div>
                            <h6 class="my-0">Minhas Rifas</h6>
                            <small class="text-muted" id="endereco">-</small>
                        </div>
                        <span id="total-rifas" class="text-muted"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                        <div>
                            <h6 class="my-0">Total de Rifas</h6>
                            <small class="text-muted">Total de rifas vendidas</small>
                        </div>
                        <span class="text-muted" id="total-geral"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                        <div>
                            <h6 class="my-0">Prêmio do Vencedor</h6>
                            <small class="text-muted">em ether</small>
                        </div>
                        <span class="text-muted" id="premio"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <h6 class="my-0">Ganhador</h6>
                        <span class="text-muted" id="ganhador"></span>
                    </li>
                </ul>

                <form class="card p-2">
                    <div class="input-group">
                        <input type ="text" class="form-control" id="tweet" placeholder="Quantidade">
                        <div class="input-group-append">
                            <button type="button" onclick="postarTwitter()" class="btn btn-secondary">Postar</button>
                        </div>
                    </div>
                    
                </form>
                <br>
                <button type="button" onclick="getTwitters()" class="btn btn-danger btn-lg btn-block" id="drawBtn">Ver Twitters</button>
            </div>



        </div>

        <footer class="my-5 pt-5 text-muted text-center text-small">
            <p class="mb-1">IMD - IMD0729</p>
        </footer>
    </div>

    <script>
        var twitter;
        var userAccount;
        var acc;

        function startApp() {
            var rifaAddress = "0x3953528B2f21A1bb73d2Ce143151dD4228781a88";
            twitter = new web3.eth.Contract(abiTwitter, rifaAddress);

            web3.eth.getAccounts().then(function (result) {
                acc = result[0]

                console.log(acc)
            })  




            /* var accountInterval = setInterval(function () {

                web3.eth.getAccounts().then(function (result) {
                    acc = result[0];
                    console.log(acc)
                })

                if (acc !== userAccount) {
                    userAccount = acc;
                }
            }, 100); */

        }

        function postarTwitter() {
            var texto = document.getElementById("tweet").value;
            var ether = 1000000000000000000*0.3
            var value = web3.utils.utf8ToHex(texto);

            twitter.methods.postTweet(value).send({from : acc, value : ether});
        
            return false;
        }
        
        function getTwitters() {
            var x = twitter.methods.getIdsOfTweetByAddress().send({from : acc}).then(function (result) {
                console.log(result);
            })
            
            return false;
        }

        //function sortear() {
        //    rifa.methods.sortearRifa().send({ from: userAccount }).then(refreshData);
        //    return false;
        //}

        // Padrão para detectar um web3 injetado.
        window.addEventListener('load', function () {

            web3Provider = null;
            // Modern dapp browsers...
            if (window.ethereum) {
                web3Provider = window.ethereum;
                try {
                    // Request account access
                    window.ethereum.enable();
                } catch (error) {
                    // User denied account access...
                    console.error("User denied account access")
                }
            }
            // Legacy dapp browsers...
            else if (window.web3) {
                web3Provider = window.web3.currentProvider;
            }
            // If no injected web3 instance is detected, fall back to Ganache
            else {
                console.log('No web3? You should consider trying MetaMask!')
                web3Provider = new Web3.providers.HttpProvider('http://localhost:8545');
            }
            web3 = new Web3(web3Provider);
            startApp()

        })
    </script>

</body>

</html>

